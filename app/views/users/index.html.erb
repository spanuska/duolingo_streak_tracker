<script type="text/javascript" src="https://code.angularjs.org/1.5.0/angular.js"></script>


<div ng-app="dst">
  <div ng-controller="formController">
    <h3>Add your username to Duolingo Streak Tracker!</h3>
    <form novalidate class="simple-form" ng-submit="addUser(user)">
      Duolingo Username: <input type="text" ng-model="user.username" /><br />
      <input type="submit" value="Add Me" />
    </form>
  </div>
  <div ng-controller="usersController">
    <div ng-repeat="(key, category) in userCategories" ng-class="category-{{key}}">
      <table >
        <tr>
          <th>{{key | uppercase}}</th>
        </tr>
        <tr ng-repeat="user in category">
          <td>{{user.username}}</td>
          <td>{{user.days}}</td>
        </tr>
      </table>
      </br>
    </div>
  </div>
</div>

<script>
  var dst = angular.module('dst',[]);
  dst.controller('usersController', function($scope, $rootScope, $http){
    
    var loadUsers = function(){
      $http({
      method: 'GET',
      url: '/users.json'
    }).then(function successCallback(response) {
         $scope.userCategories = response.data;
         //console.log($scope.userCategories);
      }, function errorCallback(response) {
      });
    };

    $rootScope.$on('addUser', function() {
      loadUsers();
      //console.log("from addUser")
    });

    loadUsers();
    
  });

  dst.controller('formController', function($scope, $rootScope, $http) {
    $scope.addUser = function(){
      $scope.user = {
        'username' : $scope.user.username
      };
      $rootScope.$broadcast('addUser');
      $http({
        method: 'POST',
        url: '/users.json',
        data: $scope.user
      });
    };
  });
</script>
